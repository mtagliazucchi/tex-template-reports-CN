\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{cn-reports}[2023/10/21 v0.1]

% Titilium Font
\RequirePackage{fontspec}
\setmainfont{TitilliumWeb}[
    Path=./TitilliumWebFiles/,
    Extension = .ttf,
    UprightFont=*-Regular,
    BoldFont=*-Bold,
    ItalicFont=*-Italic,
    BoldItalicFont=*-BoldItalic
    ]

% header/footer
\RequirePackage{eso-pic}
\AddToShipoutPictureBG{%
  \AtPageUpperLeft{%
    \raisebox{-\height}{\includegraphics[width=\paperwidth]{Fig/header.pdf}}
  }
  \AtPageLowerLeft{%
    \makebox[\paperwidth]{\includegraphics[width=\paperwidth]{Fig/footer.pdf}}
  }%
}


\RequirePackage{graphicx}
\RequirePackage{hyperref}
\hypersetup{
        unicode=true,          % non-Latin characters in Acrobat’s bookmarks
        pdftoolbar=true,        % show Acrobat’s toolbar?
        pdfmenubar=true,        % show Acrobat’s menu?
        pdffitwindow=false,     % window fit to page when opened
        pdfstartview={FitH},    % fits the width of the page to the window
        pdftitle={cn-report},    % title
        pdfnewwindow=true,      % links in new PDF window
        colorlinks=true,        % false: boxed links; true: colored links
        linktoc=page,
        linkcolor=blue,         % color of internal link
        citecolor=violet,        % color of links to bibliography
        filecolor=magenta,      % color of file links
        urlcolor=purple            % color of external links
    }
%  ****************************************
%  *       ABSTRACT and KEYWORDS          *
%  ****************************************

%  abstract/summary
\def\summary{\if@twocolumn
   \start@GJbox\@summary
 \else
   \@summary
 \fi}
\def\endsummary{\if@twocolumn
   \endlist\finish@GJbox
 \else
  \endlist
 \fi}
\def\abstract{\if@twocolumn
   \start@GJbox\@summary
 \else
   \@summary
 \fi}
\def\endabstract{\if@twocolumn
   \endlist\finish@GJbox
 \else
  \endlist
 \fi}
\def\left@zm{10.5pc}
\def\@summary{\list{}{%
    \labelwidth\z@ \labelsep\z@
    \leftmargin\left@zm \rightmargin\z@
    \parsep 0pt plus 1pt}\item[]
    \normalsize{\bf ABSTRACT}\\\large}

% keywords
\newif\ifGJ@keywords
\def\keywords{\if@twocolumn
  \start@GJbox\@keywords
 \else
  \@keywords
 \fi
}
\def\@keywords{\list{}{%
    \labelwidth\z@ \labelsep\z@
    \leftmargin\left@zm \rightmargin\z@
    \parsep 0pt plus 1pt}\item[]\reset@font\large{\bf Key words: }}
\def\endkeywords{\if@twocolumn
  \endlist\addvspace{37pt plus 0.5\baselineskip}\finish@GJbox
 \else
  \endlist
 \fi
 \@thanks
 \gdef\@thanks{}
 \GJ@keywordstrue
}
\def\nokeywords{\ifGJ@keywords\else
 \if@twocolumn \start@GJbox\addvspace{37pt}\finish@GJbox \fi
 \@thanks
 \gdef\@thanks{}\fi
}

%  ****************************************
%  *               SECTIONS               *
%  ****************************************
\def\@startsection#1#2#3#4#5#6{\if@noskipsec \leavevmode \fi
   \par \@tempskipa #4\relax
   \@afterindenttrue
   \ifdim \@tempskipa <\z@ \@tempskipa -\@tempskipa \@afterindentfalse\fi
   \if@nobreak
     \everypar{} \ifnum#2=2 \vskip 0pt plus1pt\fi % was 6pt
   \else
     \addpenalty{\@secpenalty}\addvspace{\@tempskipa}
   \fi \@ifstar
     {\@ssect{#3}{#4}{#5}{#6}}{\@dblarg{\@sect{#1}{#2}{#3}{#4}{#5}{#6}}}}

\def\GJ@hangraggedright{\rightskip=\@flushglue \let\\=\@centercr \parindent=0pt}

\def\section{\@startsection{section}{1}{\z@}
 {-24pt plus -12pt minus -1pt}{6pt}
 {\GJ@hangraggedright\reset@font\normalsize\bf}}
\def\subsection{\@startsection{subsection}{2}{\z@}
 {-18pt plus -9pt minus -1pt}{6pt}
 {\GJ@hangraggedright\reset@font\normalsize\bf}}
\def\paragraph{\@startsection{paragraph}{4}{\z@}
{0pt}{-0.5em}{\reset@font\normalsize\bf}}
\renewcommand\theparagraph{}

\setcounter{secnumdepth}{4}
%
\newif\if@levelone
%
% \@sect{NAME}{LEVEL}{INDENT}{BEFORESKIP}{AFTERSKIP}{STYLE}[ARG1]{ARG2}
\def\@sect#1#2#3#4#5#6[#7]#8{%
  \ifnum #2>\c@secnumdepth
  \def\@svsec{}%
 \else
  \refstepcounter{#1}
   \ifnum #2=\@ne \global\@levelonetrue % if level=1 ie. section
   \ifGJ@appendix \edef\@svsec{}%
     \else \edef\@svsec{\csname the#1\endcsname\hskip 1em}%
   \fi
  \else \edef\@svsec{\csname the#1\endcsname\hskip 1em}%
  \fi
 \fi
 \@tempskipa #5\relax
 \ifdim \@tempskipa>\z@
  \begingroup #6\relax
   \ifnum #2=\@ne
    \ifGJ@appendix
     \@hangfrom{\hskip #3\relax\@svsec}{\interlinepenalty \@M
      APPENDIX \csname the#1\endcsname:\hskip 0.5em\uppercase{#8}\par}%
    \else
     \@hangfrom{\hskip #3\relax\@svsec}{\interlinepenalty \@M
      \uppercase{#8}\par}%
    \fi
   \else
    \@hangfrom{\hskip #3\relax\@svsec}{\interlinepenalty \@M #8\par}%
   \fi
  \endgroup
   \csname #1mark\endcsname{#7}%
   \addcontentsline{toc}{#1}{\ifnum #2>\c@secnumdepth \else %ajw
   \protect\numberline{\csname the#1\endcsname}\fi #7}%ajw
 \else
  \def\@svsechd{#6\hskip #3\@svsec \ifnum #2=\@ne\uppercase{#8}\else #8\fi
  \csname #1mark\endcsname{#7}
  \addcontentsline{toc}{#1}{\ifnum #2>\c@secnumdepth \else %ajw
  \protect\numberline{\csname the#1\endcsname}\fi#7}%ajw
  }\fi
 \@xsect{#5}}

% from latex.tex
%   \@ssect{INDENT}{BEFORESKIP}{AFTERSKIP}{STYLE}{ARG}
\def\@ssect#1#2#3#4#5{%
  \@tempskipa #3\relax
    \ifdim \@tempskipa>\z@
      \begingroup #4\@hangfrom{\hskip #1}{%
      \interlinepenalty \@M
      \if@levelone
        \uppercase{#5}\global\@levelonefalse
      \else{#5}
      \fi\par}%
     \endgroup
    \else
      \def\@svsechd{#4\hskip #1\relax
      \if@levelone
        \uppercase{#5}\global\@levelonefalse
      \else{#5}
      \fi}
    \fi
  \@xsect{#3}%
}

\newif\ifGJ@appendix
\def\appendix{\par
 \GJ@appendixtrue
 \setcounter{section}{0}
% \def\thesection{A\arabic{section}}
 \renewcommand\thesection{\Alph{section}}
 \renewcommand\thesubsection{\thesection\arabic{subsection}}
 \setcounter{equation}{0}
% \def\theequation{A\arabic{equation}}
 \@newctr{equation}[section]
\renewcommand\theequation{\hbox{\normalsize\Alph{section}\arabic{equation}}}
%\renewcommand\theequation{\hbox{\Alph{section}\arabic{equation}}}
\setcounter{figure}{0}
 \renewcommand\thefigure{A\@arabic\c@figure}
 \setcounter{table}{0}
 \renewcommand\thetable{A\@arabic\c@table}
}

%  ****************************************
%  *               TITLEPAGE              *
%  ****************************************
\newif\ifnotoc\notocfalse
\newif\ifemailadd\emailaddfalse
\newif\iftoccontinuous\toccontinuousfalse
\def\@collaboration{\@empty}
\def\@collaborationImg{\@empty}
\def\@proceeding{\@empty}
%authors and affiliations
\newtoks\auth@toks
\renewcommand{\author}[2][]{%
  \if!#1!%
    \auth@toks=\expandafter{\the\auth@toks#2\ }%
  \else
    \auth@toks=\expandafter{\the\auth@toks#2$^{#1}$\ }%
  \fi
}

\newtoks\affil@toks\newif\ifaffil\affilfalse
\newcommand{\affiliation}[2][]{%
\affiltrue
  \if!#1!%
    \affil@toks=\expandafter{\the\affil@toks{\item[]#2}}%
  \else
    \affil@toks=\expandafter{\the\affil@toks{\item[$^{#1}$]#2}}%
  \fi
}

%emails
%automatically put a comma between emails
\newtoks\email@toks\newcounter{email@counter}%
\setcounter{email@counter}{0}%
\newcommand{\emailAdd}[1]{%
\emailaddtrue%
\ifnum\theemail@counter>0\email@toks=\expandafter{\the\email@toks, \@email{#1}}%
\else\email@toks=\expandafter{\the\email@toks\@email{#1}}%
\fi\stepcounter{email@counter}}
\newcommand{\@email}[1]{\href{mailto:#1}{\rm #1}}

% Collaboration macros
\newcommand*\collaboration[1]{\gdef\@collaboration{#1}}
\newcommand*\collaborationImg[2][]{\gdef\@collaborationImg{#2}}

%all pieces get a ``after'' spacing
\newcommand\afterLogoSpace{\vskip3pt plus3pt minus1pt}
\newcommand\afterSubheaderSpace{\vskip3pt plus 2pt minus 1pt}
\newcommand\afterProceedingsSpace{\vskip13pt plus1.5fil minus8pt}
\newcommand\afterTitleSpace{\vskip50pt}
\newcommand\afterCollaborationSpace{\vskip3pt plus 2pt minus 1pt}
\newcommand\afterCollaborationImgSpace{\vskip3pt plus 2pt minus 1pt}
\newcommand\afterAuthorSpace{\vskip-13pt plus1pt minus4pt}
\newcommand\afterAffiliationSpace{\vskip-2pt plus3pt minus0.5pt}
\newcommand\afterEmailSpace{\vskip13pt plus8pt minus8pt}
\newcommand\afterXtumSpace{\par\bigskip}
\newcommand\afterAbstractSpace{\vskip13pt plus8pt minus11pt}
\newcommand\afterKeywordsSpace{\vskip13pt plus8pt minus11pt}
\newcommand\afterArxivSpace{\vskip3pt plus0.01fil minus10pt}
\newcommand\afterDedicatedSpace{\vskip0pt plus0.01fil}
\newcommand\afterTocSpace{\medskip}
%this is the ``itemsep'' of the affiliations list
\newlength{\affiliationsSep}\setlength{\affiliationsSep}{-3pt}
%this hook is needed if the toc starts on the first page

\DeclareFixedFont\trfont{OT1}{phv}{b}{sc}{11}

% First page
\renewcommand\maketitle{
% Title
{{\Huge \flushleft\sffamily\bfseries\@title\par} }
\afterTitleSpace
% Collaboration
\if!\@collaboration!\else
{\Large\bfseries\sffamily\raggedright\@collaboration}\par
\afterCollaborationSpace
\fi
\if!\@collaborationImg!\else
{\normalsize\bfseries\sffamily\raggedright\@collaborationImg}\par
\afterCollaborationImgSpace
\fi
% Author
{\renewcommand{\baselinestretch}{.9}
{\Large \bfseries\raggedright\sffamily\the\auth@toks\par}}
\afterAuthorSpace
% Affiliation
\ifaffil\begin{list}{}{%
\setlength{\leftmargin}{0.28cm}%
\setlength{\labelsep}{0pt}%
\setlength{\itemsep}{\affiliationsSep}}
\the\affil@toks
\end{list}\fi
\afterAffiliationSpace
% E-mail
\ifemailadd %% if emailadd is true
\noindent\hspace{0.28cm}\begin{minipage}[l]{.9\textwidth}
\begin{flushleft}
E-mail: \the\email@toks
\end{flushleft}
\end{minipage}
\else %% if emailaddfalse do nothing
\PackageWarningNoLine{\jname}{E-mails are missing.\MessageBreak Please use \protect\emailAdd\space macro to provide e-mails.}
\fi
\afterEmailSpace
} % close the \renewcommand\maketitle{



\def\tmp#1 #2\relax{#1}
\setbox0=\hbox{$\xdef\intfont{%
    \expandafter\tmp\fontname\textfont3\expandafter\space\space\relax}$}
\font\tmp=\intfont\space at10pt\relax
\setbox0=\hbox{$\textfont3=\tmp \displaystyle \int$}
\dimen0=\ht0 \advance\dimen0 by\dp0 \divide\dimen0 by10 
\xdef\intsize{\the\dimen0}

\def\dividedimen (#1/#2){\expandafter\ignorept\the
   \dimexpr\numexpr\number\dimexpr#1\relax
   *65536/\number\dimexpr#2\relax\relax sp\relax
}
{\lccode`\?=`\p \lccode`\!=`\t  \lowercase{\gdef\ignorept#1?!{#1}}}

\def\flexibleint{\def\fxintL{}\def\fxintU{}\futurelet\next\fxintA} %[ to use \flexibleint_{a}^{b} {integrand} (bracket needed)]
\def\fxintA{\ifx\next_\expandafter\fxintB\else\expandafter\fxintC\fi}
\def\fxintB_#1{\def\fxintL{#1}\futurelet\next\fxintD}
\def\fxintC{\futurelet\next\fxintD}
\def\fxintD{\ifx\next^\expandafter\fxintE\else\expandafter\fxintF\fi}
\def\fxintE^#1{\def\fxintU{#1}\fxintF}
\def\fxintF#1{\begingroup
   \setbox0=\hbox{$\displaystyle{#1}$}%
   \dimen0=\ht0 \advance\dimen0 by\dp0
   \setbox1=\hbox{$\vcenter{\copy0}$}%
   \font\tmp=\intfont\space at\dividedimen(\dimen0/\intsize)pt
   \lower\dimexpr\dp0-\dp1\hbox{%
      $\textfont3=\tmp \displaystyle\int\limits_{\fxintL}^{\fxintU}$}
   \box0
   \endgroup
}